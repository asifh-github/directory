<!DOCTYPE html>
<head>
    <title>QuickQook-Update Post</title>
    <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script type="text/javascript" src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    <link rel="stylesheet" type="text/css" href="/stylesheets/main.css" />
    <script>
        function update_recipe() {
            var ingdArr = [];
            var ingdList =   document.getElementById('add_ringd').innerHTML;
            ingdArr = ingdList.split(':');
            console.log(ingdArr);
            // setup ingredient flieds
            var ingdDiv = document.getElementById('add_ringd');
            console.log(ingdDiv);
            var _ringd = this.document.getElementById('recipeIngd').value;
            console.log(_ringd);
            ingdDiv.innerHTML = "";
            for(var i=1; i<=_ringd; i++) {
                ingdDiv.innerHTML += `<div class="form-row col-md-7"><label for="ingd${i}">Ingredient ${i}</label><input type="text" class="form-control" id="ingd${i}" name="f_ingd${i}" placeholder="Include Name" value="${ingdArr[i-1]}"></div>`;
            }
            var valid = false;
            // listen to change
            addEventListener('change', function(event) {
                console.log(event.target.id);
                valid = false;
                // reset ingredient flieds
                if(event.target.id == 'recipeIngd') {
                    _ringd = this.document.getElementById('recipeIngd').value;
                    console.log(_ringd);
                    ingdDiv.innerHTML = "";
                    for(var i=1; i<=_ringd; i++) {
                        ingdDiv.innerHTML += `<div class="form-row col-md-7"><label for="ingd${i}">Ingredient ${i}</label><input type="text" class="form-control" id="ingd${i}" name="f_ingd${i}" placeholder="Include Name" value=""></div>`;
                        if(i === 10) {
                            ingdDiv.innerHTML += `<div class="form-row col-md-7"><button id="addRingd_btn" type="button" class="form-control container btn btn-link" style="width: 200px;margin-top: 10px; margin-bottom: 15px;" onclick="" disabled="disabled">Add Ingredient</button></div>`;
                        }
                    }
                }
                console.log(ingdDiv);
                console.log(ingdDiv.childNodes[0].childNodes[1].value);
                // get input fileds value
                var _rname = this.document.getElementById('recipeName').value;
                console.log(_rname);
                var _rtime = this.document.getElementById('recipeTime').value;
                console.log(_rtime);
                var _rinfo = this.document.getElementById('recipeInfo').value;
                console.log(_rinfo);
                // check valid requirements for inputs
                if(/^[a-zA-Z\s\-]+$/.test(_rname)) {
                    this.document.getElementById('recipeName').style.background = 'none';
                    if(parseInt(_rtime) !== 0) {
                        this.document.getElementById('recipeTime').style.background = 'none';
                        console.log(ingdDiv.childNodes.length);
                        for(var i=0; i<ingdDiv.childNodes.length; i++) {
                            var _temp = ingdDiv.childNodes[i].childNodes[1];
                            console.log("printing value of input " + _temp.value);
                            if(/^[0-9a-zA-Z\s\-\+_=,\.()]+$/.test(_temp.value)) {
                                _temp.setAttribute('style', 'background:none');
                                if(i === (ingdDiv.childNodes.length-1)) {
                                    console.log("reached last test");
                                    if(/^[0-9a-zA-Z\s\n\-\+_=,\.()\[\]]{50,10000}$/.test(_rinfo)) {
                                        this.document.getElementById('recipeInfo').style.background = 'none';
                                        valid = true;
                                        console.log(valid);
                                    }
                                    else{
                                        this.document.getElementById('recipeInfo').style.background = 'lightgrey';
                                        console.log(valid);
                                    }
                                }
                            }
                            else {
                                _temp.setAttribute('style', 'background:lightgrey');
                            }
                        }
                    }
                    else{
                        this.document.getElementById('recipeTime').style.background = 'lightgrey';
                    }
                }
                else{
                    this.document.getElementById('recipeName').style.background = 'lightgrey';
                }
                if(valid) {
                    document.getElementById('update').removeAttribute('disabled');
                }
                else{
                    document.getElementById('update').setAttribute('disabled', 'disabled');
                }
            });
        }
    </script>
</head>
<body onload="update_recipe()">
  <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <a class="navbar-brand" href="/profile">QuickQook</a>
      <div class="container-fluid">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link" href="/profile">Home</a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" href="/posts">Posts</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/liked">Liked</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/favourites">Favourites</a>
          </li>
        </ul>
        <ul class="navbar-nav navbar-right">
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownMenuLink" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              <%= post.fname %>
              <%= post.lname %>
            </a>
            <div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
              <a class="dropdown-item" href="/profile_update">Update</a>
              <div class="dropdown-divider"></div>
              <a class="dropdown-item" href="/logout">Logout</a>
            </div>
          </li>
        </ul>
      </div>
    </nav>
    <header class="container-md text-center">
        <h2>QQ: Edit Post</h2>
        <h4>
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-heart-fill" viewBox="0 0 16 16">
            <path fill-rule="evenodd" d="M8 1.314C12.438-3.248 23.534 4.735 8 15-7.534 4.736 3.562-3.248 8 1.314z"/></svg>
            <i class="bi bi-heart-fill"><%= post.postlikes %></i>
        </h4>
    </header>
    <main class="container-sm">
        <form id="editRecipeForm" action="/postUpDel/:<%= post.postid %>:<%= post.postlikes %>" method="post">
            <div class="form-group">
                <label for="emailForAdd">Email address</label>
                <input type="email" class="form-control" id="emailForAdd" name="f_emailForAdd" value="<%= post.email %>" aria-describedby="emailHelp" readonly="readonly">
                <small id="emailHelp" class="form-text text-muted">We'll never share your email with anyone else.</small>
            </div>
            <hr class="mt-3 mb-3"/>
            <div class="form-row">
                <div class="form-group col-md-6">
                  <label for="recipeName">Recipe Name</label>
                  <input type="text" class="form-control" id="recipeName" name="f_recipeName" value="<%= post.postname %>">
                </div>
                <div class="form-group col-md-3">
                  <label for="recipeTime">Cook Time</label>
                  <select class="form-control" id="recipeTime" name="f_recipeTime">
                    <option value=<%= post.postctime %> selected><%= post.postctime %></option>
                    <option value=1>Less Than 10 mins</option>
                    <option value=2>10-15 mins</option>
                    <option value=3>15-20 mins</option>
                    <option value=4>20-25 mins</option>
                    <option value=5>25-30 mins</option>
                    <option value=6>30-35 mins</option>
                    <option value=7>35-40 mins</option>
                    <option value=8>40-45 mins</option>
                    <option value=9>45-50 mins</option>
                    <option value=10>50-55 mins</option>
                    <option value=11>55-60 mins</option>
                    <option value=12>60+ mins</option>
                  </select>
                </div>
                <div class="form-group col-md-3">
                  <label for="recipeIngd">Number of Ingredients</label>
                  <select class="form-control" id="recipeIngd" name="f_recipeIngd">
                    <option value=<%= post.postingd %> selected><%= post.postingd %></option>
                    <option value=3>3</option>
                    <option value=4>4</option>
                    <option value=5>5</option>
                    <option value=6>6</option>
                    <option value=7>7</option>
                    <option value=8>8</option>
                    <option value=9>9</option>
                    <option value=10>10 or more</option>
                  </select>
                </div>
              </div>
              <span id="add_ringd" style="font-style: italic;"><%= post.postingdlist %></span>
              <div class="form-group">
                <label for="recipeInfo">Description</label>
                <textarea class="form-control" placeholder="Minimun 50 & Maximun 10,000 Characters" id="recipeInfo" name="f_recipeInfo" rows="4"><%= post.postinfo %></textarea>
              </div>
            <div class="container text-center btn-group btn-block" style="width: 750px; display: flex;">
                <input type="submit" class="btn btn-warning" id="delete" name="post_delete"
                value="Delete Post" onclick="return confirm('Confirm delete post?')">
                <input type="submit" class="btn btn-primary" id="update" name="post_update"
                value="Update Post" onclick="return confirm('Confirm update post?')">
            </div>
            <div class="container text-center btn-block">
                <button id="back" name="post_back" class="btn btn-outline-dark" style="width: 720px; margin-bottom: 25px;">
                    Go Back
                </button>
            </div>
        </form>
    </main>
    <footer></footer>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>
    <script>
        var ctimeArr = ['NA', 'Less Than 10 mins', '10-15 mins', '15-20 mins', '20-25 mins', '25-30 mins', '30-35 mins', '35-40 mins', '40-45 mins', '45-50 mins', '50-55 mins', '55-60 mins', '60+ mins'];
        var ctime = document.getElementById('recipeTime').firstElementChild;
        ctime.innerHTML = ctimeArr[ctime.value];
    </script>
</body>
</html>
